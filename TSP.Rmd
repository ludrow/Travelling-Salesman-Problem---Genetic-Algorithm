---
title: "Travelling Salesman Problem - Genetic Algorithm"
author: "Ludwik Przyrowski"
date: "9 kwietnia 2017"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE, echo = TRUE)
```

## Problem Komiwoja¿era (ang. Travelling Salesman Problem)

Poni¿szy skrypt jest rozwi¹zaniem zadañ z laboratorium Sztucznej inteligejncji bêd¹cego przedmiotem na kierunku Data Science na Politechnice Warszawskiej prowadzonego przez Ph.D. Kamila ¯bikowskiego.

Celem æwiczenia jest rozwi¹zanie problemu komiwoja¿era (cyklu Hamiltona w pe³nym grafie wa¿onym) z wykorzystaniem algorytmów genetycznych.

## Zadanie 1
```{r }
cities = read.csv("data/cities.csv", header = TRUE, sep=",")
head(cities)
```

## Zadanie 2
Napisz funkcjê, która obliczy dystans pomiêdzy wszystkimi odwiedzanymi miastami.

Funkcja przyjmuje dwa parametry:  

* visitedCities - wektor od d³ugoœci k, gdzie k to liczba odwiedzonych miast;
kolejnoœæ wartoœci w ramach tego wektora bêdzie odzwierciedla³a kolejnoœæ
odwiedzania miast,

* distances - macierz odleg³oœci miêdzy dowolnymi dwoma miastami
```{r}
totalDistance = function(visitedCities, distances=cities) {
visitedCities = c(visitedCities, visitedCities[1])
route = embed(visitedCities, 2)[, 2:1]
distancesSum = sum(distances[route])
return(distancesSum)
}
```
szybki test:
```{r}
totalDistance(c('Warsaw', 'London'))
```
## Zadanie 3
Zastanówmy siê nad rozwi¹zaniem, które przeszukiwa³oby przestrzeñ wszystkich mo¿liwych po³¹czeñ pomiêdzy miastami. W tym celu skorzystaj z poni¿szej funkcji:
```{r}
permu <- function(perm, fun, current=NULL){
  for(i in 1: length(perm)){
    fix <- c(current, perm[i]) # calculated elements; fix at this point
    rest <- perm[-i] # elements yet to permutate
    #Call callback.
    if(!length(rest)){
      result <- fun(fix)
    if(result<bestResult){
      assign("bestResult", result, envir = .GlobalEnv)
      print(bestResult)
      }
    }
    if(length(rest)){
      result <- permu(rest, fun, fix)
    }
  }
}
```
Funkcja “permu” korzysta ze zmiennej globalnej bestResults zdefiniowanej jako:
```{r}
bestResult <- 99999
```
(Definiowanie i korzystanie ze zmiennych globalnych jest antywzorcem)

Wywo³aj funkcjê “permu” dla fun=totalDistance i podaj adekwatn¹ wartoœæ parametru
“perm” tak, aby przeszukiwana by³a ca³a przestrzeñ rozwi¹zañ.
```{r}
permu(c('Belgrade','Berlin','Brussels','Bucharest','Budapest','Copenhagen','Dublin', 'Hamburg'), totalDistance)
```
**Widaæ, ¿e obliczenia trwaj¹ bardzo d³ugo wiêc przyk³ad tylko dla ograniczonej listy**

## Zadanie 4
Teraz kiedy mamy ju¿ dosyæ dobre zrozumienie problemu zastanówmy siê nad jego
z³o¿onoœci¹ obliczeniow¹ w zale¿noœci od liczby miast. Czy jesteœ w stanie podaæ
aproksymacjê z³o¿onoœci? Skorzystaj w tym celu z funkcji “factorial”.  
**Z³o¿onoœæ mo¿na okreœliæ jako [1]:  
Startuj¹c z pierwszego miasta mamy (n-1) miast do wyboru, z drugiego (n-2) miast do wyboru i tak dalej (n-1)(n-2)(n-3)...x3x2x1  
itd. Jako, ¿e koszt przejazdu mierzony jest w jedn¹ stronê dzielimi wszystko przez dwa i finalnie:  
(n-1)!/2**

## Zadanie 5
W tym i kolejnych zadaniach korzystaæ bêdziemy z funkcji z biblioteki “GA”[1]. Zainstaluj i
za³aduj j¹ przy pomocy poleceñ:

```{r, warning=F}
library(GA)
```
… wprowadzenie do Algorytmów Genetycznych

## Zadanie 6
Zaproponuj funkcjê kosztu dla algorytmu genetycznego.
** Najprostrza funkcja do minimalizacji to -1 x koszt podró¿y

```{r}

costFunction <-function(cfVisitedCities, ...){
  -(totalDistance(cfVisitedCities,...))
}
```

## Zadanie 7
Skorzystaj z funkcji “ga” w celu wybrania optymalnej wartoœci trasy z ograniczon¹ liczb¹
iteracji do 500. Zapoznaj siê z parametryzacj¹ funkcji “min”, “max” oraz “maxiter”. Ustaw
typ parametryzacji na “permutation”. Zapoznaj siê z innymi typami zmiennych
decyzyjnych.
Zak³adaj¹c, ¿e GA.fit zawiera wynik wykonania funkcji “ga” sprawdŸ najlepsze
rozwi¹zanie oraz narysuj wykres dochodzenia do rozwi¹zania przez algorytm
genetyczny.
```{r}
GA.fit <- ga(
  type = "permutation"
  ,fitness = costFunction
  ,min = 1
  ,max = length(cities)
  ,maxiter = 500)
min(GA.fit@fitness)
plot(GA.fit)
```
  
a) Czy zauwa¿y³eœ problem z tak¹ definicj¹ zmiennych decyzyjnych w kontekœcie  
badanego problemu? Jak¹ faktycznie z³o¿onoœæ ma takie podejœcie?
b) Zwróæ uwagê na fakt, i¿ zastosowanie operatorów krzy¿owania i mutacji w wersji
podstawowej spowodowa³oby z³amanie warunków okreœlonych dla zmiennych
decyzyjnych.  
c) * Zaproponuj operator mutacji dla omawianego problemu.  
d) * Zaproponuj operator krzy¿owania dla omawianego problemu.  

[1] http://www.math.uwaterloo.ca/tsp/problem/pcb3cnt.html  
[2] Luca Scrucca (2013). GA: A Package for Genetic Algorithms in R.
  Journal of Statistical Software, 53(4), 1-37. URL
  http://www.jstatsoft.org/v53/i04/.


